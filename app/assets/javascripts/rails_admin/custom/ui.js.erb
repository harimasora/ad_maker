$(document).on('rails_admin.dom_ready', function(){
  var updateSelectBox, updateNameField, hideField;

  updateSelectBox = function(api_url, child_select, json_data) {

    $.ajax( api_url, {
      type: 'GET',
      dataType: 'json',
      data: json_data,
      error: function(jqXHR, textStatus, errorThrown) {
        return alert(textStatus + ": " + errorThrown);
      },
      success: function(data, textStatus, jqXHR) {
        var elements = [];

        // we got a JSON array in data, iterate through it
        $.each(data, function(index, value) {

          // append an option
          var opt = $('<option/>');

          // value is an array: [:name, :id]
          opt.text(value[0]);
          opt.attr('value', value[1]);
          // append to select
          elements.push(opt);
        });

        var selected = child_select.val();
        child_select.filteringSelect("destroy").find("option:gt(0)").remove().end().append(elements).filteringSelect().val(selected);
      }
    });
  };

  updateNameField = function(parent_select, name_field) {
    var name = parent_select.text();
    name_field.attr('value', name);
  };

//  BUSINESS UNIT

  $(document).on('change', '#business_unit_federation_unit_id', function(event) {
    var field = $('#business_unit_federation_unit_id');
    updateSelectBox('/api/cities', $('#business_unit_city_id'), { business_unit: {federation_unit_id: field.val() }});
    updateNameField(field, $('#business_unit_federation_unit_name'))
  });

  $(document).on('change', '#business_unit_city_id', function(event) {
    var field = $('#business_unit_city_id');
    updateNameField(field, $('#business_unit_city_name'))
  });

  $('#business_unit_federation_unit_name_field').hide();
  $('#business_unit_city_name_field').hide();

//  PRODUCTION ORDER

  $(document).on('change', '#production_order_federation_unit_id', function(event) {
    var field = $('#production_order_federation_unit_id');
    updateSelectBox('/api/cities', $('#production_order_city_id'), { production_order: {federation_unit_id: field.val() }});
    updateNameField(field, $('#production_order_federation_unit_name'))
  });

  $(document).on('change', '#production_order_city_id', function(event) {
    var field = $('#production_order_city_id');
    updateSelectBox('/api/districts', $('#production_order_district_id'), { production_order: {city_id: field.val() }});
    updateNameField(field, $('#production_order_city_name'))
  });

  $(document).on('change', '#production_order_district_id', function(event) {
    var field = $('#production_order_district_id');
    updateNameField(field, $('#production_order_district_name'))
  });

  $('#production_order_federation_unit_name_field').hide();
  $('#production_order_city_name_field').hide();
  $('#production_order_district_name_field').hide();

});